function $_global_geolocationfieldtemplate(){(function(){a:;if(typeof GeolocationFieldTemplate=="object")return;window.GeolocationFieldTemplate=function(){a:;var a='<img src="/_layouts/15/images/loadingcirclests16.gif?rev=23" style="display:block;padding-left:40%;padding-top:20%;" width="16px" height="16px" />';return{SPFieldGeolocation_Display:function(e){if(e==null||e.CurrentFieldValue==null||e.CurrentFieldValue=="")return"";var h,i,l=e.CurrentItem,f=GeolocationFieldTemplate.ParseGeolocationValue(l[e.CurrentFieldSchema.Name]),b=SPClientTemplates.Utility.GetFormContextForCurrentField(e);if(b==null||b.fieldSchema==null)return"";var d=null,g=b.fieldName+"_"+b.fieldSchema.Id+"_$geolocationField";b.registerInitCallback(b.fieldName,k);var c='<div id="'+STSHtmlEncode(g)+'" style=" width:450px; height:300px; position:relative;">';c+='<a id="mapAnchor_'+STSHtmlEncode(g)+'" href="javascript:;" style="display:block; width:100%; height:100%;" ';c+='title="'+STSHtmlEncode(Strings.STS.L_BingMapsControl)+'">';c+=a;c+="</a>";c+="</div>";c+='<a id="viewOnMap_'+STSHtmlEncode(g)+'" href="';c+=GeolocationFieldTemplate.GetRedirectUrl(e.CurrentUICultureName,f.latitude,f.longitude);c+='" title="'+STSHtmlEncode(Strings.STS.L_ViewOnMap)+'" target=_blank >'+STSHtmlEncode(Strings.STS.L_ViewOnMap)+"</a>";return c;function k(){a:;var a=b.fieldSchema.IsBingMapBlockedInCurrentRegion;h=document.getElementById(g);i=document.getElementById("mapAnchor_"+g);if(h!=null){ExecuteOrDelayUntilEventNotified(function(){a:;SP.Maps.BingMaps.blockedStatus(a);m(f.latitude,f.longitude,h);j(f.latitude,f.longitude)},"bingmapjsloaded");if(i!=null){AddEvtHandler(i,"onfocus",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;d.disableKeyboardInputOnMap(false)},"bingmapjsloaded")});AddEvtHandler(i,"onblur",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;d.disableKeyboardInputOnMap(true)},"bingmapjsloaded")});AddEvtHandler(h,"onmouseover",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;d.disableKeyboardInputOnMap(false)},"bingmapjsloaded")});AddEvtHandler(h,"onmouseout",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;d.disableKeyboardInputOnMap(true)},"bingmapjsloaded")})}}}function m(f,e,g){var c=null;if(window.frameElement==null)c=document.activeElement;d=new SP.Maps.MapProviderFactory.createMapProvider("bing","7.0");var a=new SP.Maps.SPMapOption;a.mapDiv=g;a.center=new SP.Maps.Geolocation(f,e);if(typeof b.fieldSchema.BingMapsKey!="undefined"&&b.fieldSchema.BingMapsKey!=null)a.apiKey=b.fieldSchema.BingMapsKey;d.loadMap(a);d.disableKeyboardInputOnMap(true);c!=null&&c.focus()}function j(e,c){var b=[],a={};a.latitude=e;a.longitude=c;a.isDraggable=false;a.showHover=false;a.icon="/_layouts/15/images/MapPushpin.25x39x32.png?rev=23";b.push(a);d.addPushpins(b)}},ParseGeolocationValue:function(c){var k="POINT",h=" ",j="(",i=")",d={};d.longitude=null;d.latitude=null;d.altitude=null;d.measure=null;if(c==null||c=="")return null;var a=0,l=c.length,e,f=0,b=c.indexOf(j,a);if(b<=a)return null;var g=b;if(c.charCodeAt(b-1)==h.charCodeAt(0))g--;e=c.substr(a,g-a);if(k.toLowerCase()!=e.toLowerCase())return null;a=b+1;while(a<l){b=c.indexOf(h,a);if(b<=a)b=c.indexOf(i,a);if(b<=a)return null;e=c.substr(a,b-a);if(f==0)d.longitude=parseFloat(e);else if(f==1)d.latitude=parseFloat(e);else if(f==2)d.altitude=parseFloat(e);else if(f==3)d.measure=parseFloat(e);f++;a=b+1}return f<2?null:d},SPFieldGeolocation_Edit:function(l){if(l==null)return"";var b=SPClientTemplates.Utility.GetFormContextForCurrentField(l);if(b==null||b.fieldSchema==null)return"";var d=null,c=null,h,k,i,n,p,f=null,u=b.fieldName+"_"+b.fieldSchema.Id+"_$geolocationField_DefineLocation",t=b.fieldName+"_"+b.fieldSchema.Id+"_$geolocationField_UseCurrentLocation",v=b.fieldName+"_"+b.fieldSchema.Id+"_$geolocationField_ClearLocation",j=b.fieldName+"_"+b.fieldSchema.Id+"_$geolocationField_MapDiv",J=b.fieldValue!=null?b.fieldValue:"",I=l.CurrentItem,g=GeolocationFieldTemplate.ParseGeolocationValue(I[l.CurrentFieldSchema.Name]);if(g!=null){d=g.latitude;c=g.longitude}var x=new SPClientForms.ClientValidation.ValidatorSet;b.fieldSchema.Required&&x.RegisterValidator(new SPClientForms.ClientValidation.RequiredValidator);b.registerClientValidator(b.fieldName,x);b.registerInitCallback(b.fieldName,H);b.registerFocusCallback(b.fieldName,function(){a:;i!=null&&i.focus()});b.registerValidationErrorCallback(b.fieldName,function(a){a:;SPFormControl_AppendValidationErrorMessage(j,a)});b.registerGetValueCallback(b.fieldName,function(){a:;return d==null&&c==null?"":g!=null&&g.altitude!=null&&g.measure!=null?"Point("+String(c)+" "+String(d)+" "+String(g.altitude)+" "+String(g.measure)+")":"Point("+String(c)+" "+String(d)+")"});b.updateControlValue(b.fieldName,J);var q=STSHtmlEncode(Strings.STS.L_Geolocation_setLocation),A='<a id="'+STSHtmlEncode(u)+'" href="javascript:">',z='<a id="'+STSHtmlEncode(t)+'" href="javascript:">';q=q.replace(/{(0)}/,A).replace(/{(1)}/,"</a>").replace(/{(2)}/,z).replace(/{(3)}/,"</a>");var m=STSHtmlEncode(Strings.STS.L_Geolocation_BingMapsUserWarning),C=STSHtmlEncode(Strings.STS.L_Language_Text),F='<a href="http://officeredir.microsoft.com/r/rlidBingMapToU?Clid='+C+'" target="_blank">';m=m.replace(/{(0)}/,F).replace(/{(1)}/,"</a>");var e='<table width="100%"><tbody><tr><td>';e+=q;e+='</td><td style="width:30px;"></td><td>';e+='<a id="'+STSHtmlEncode(v)+'" class="ms-floatRight" href="javascript:">'+STSHtmlEncode(Strings.STS.L_ClearLocation)+"</a>";e+='</td></tr><tr><td colspan="3"><span>';e+=m;e+="</span></td></tr></tbody></table>";e+='<div id="'+STSHtmlEncode(j)+'" ';if(g!=null)e+='style="width:450px;height:300px;" ';e+=" >";e+='<a id="mapAnchor_'+STSHtmlEncode(j)+'" href="javascript:;" style="display:block; width:100%; height:100%;" ';e+='title="'+STSHtmlEncode(Strings.STS.L_BingMapsControl)+'">';if(g!=null)e+=a;e+="</a>";e+="</div>";return e;function s(){a:;var b=document.getElementById(j),c=document.getElementById("mapAnchor_"+j);if(c!=null&&b!=null){b.style.height="300px";b.style.width="450px";c.innerHTML=a;window.frameElement!=null&&typeof window.frameElement.autoSize=="function"&&window.frameElement.autoSize()}}function B(){a:;if(navigator.geolocation==undefined)alert(STSHtmlEncode(Strings.STS.L_Nav_Geolocation_Undefined));else navigator.geolocation.watchPosition(D,G)}function G(a){if(a.code==a.PERMISSION_DENIED)alert(STSHtmlEncode(Strings.STS.L_Err_Permission_Denied));else if(a.code==a.POSITION_UNAVAILABLE)alert(STSHtmlEncode(Strings.STS.L_Err_Position_Unavailable));else alert(STSHtmlEncode(Strings.STS.L_Err_Timeout))}function D(a){d=a.coords.latitude;c=a.coords.longitude;if(d!=null&&c!=null&&h!=null){s();ExecuteOrDelayUntilEventNotified(function(){a:;r(d,c,h);o(d,c)},"bingmapjsloaded")}}function r(g,e,c){if(f==null){var d=null;if(window.frameElement==null)d=document.activeElement;f=new SP.Maps.MapProviderFactory.createMapProvider("Bing","7.0");c.style.position="relative";var a=new SP.Maps.SPMapOption;a.mapDiv=c;a.center=new SP.Maps.Geolocation(g,e);a.height=300;a.width=450;if(typeof b.fieldSchema.BingMapsKey!="undefined"&&b.fieldSchema.BingMapsKey!=null)a.apiKey=b.fieldSchema.BingMapsKey;f.loadMap(a);f.disableKeyboardInputOnMap(true);d!=null&&d.focus();window.frameElement!=null&&typeof window.frameElement.autoSize=="function"&&window.frameElement.autoSize();k=document.getElementById("mapAnchor_"+j);if(k!=null){AddEvtHandler(k,"onfocus",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;f.disableKeyboardInputOnMap(false)},"bingmapjsloaded")});AddEvtHandler(k,"onblur",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;f.disableKeyboardInputOnMap(true)},"bingmapjsloaded")});AddEvtHandler(c,"onmouseover",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;f.disableKeyboardInputOnMap(false)},"bingmapjsloaded")});AddEvtHandler(c,"onmouseout",function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;f.disableKeyboardInputOnMap(true)},"bingmapjsloaded")})}}}function o(d,c){if(f!=null){var b=[],a={};a.latitude=d;a.longitude=c;a.isDraggable=false;a.showHover=false;a.icon="/_layouts/15/images/MapPushpin.25x39x32.png?rev=23";b.push(a);f.clearMap();f.addPushpins(b)}}function H(){a:;var a=b.fieldSchema.IsBingMapBlockedInCurrentRegion;i=document.getElementById(u);n=document.getElementById(t);p=document.getElementById(v);h=document.getElementById(j);ExecuteOrDelayUntilEventNotified(function(){a:;SP.Maps.BingMaps.blockedStatus(a);if(d!=null&&c!=null&&h!=null){r(d,c,h);o(d,c)}},"bingmapjsloaded");i!=null&&AddEvtHandler(i,"onclick",E);n!=null&&AddEvtHandler(n,"onclick",B);p!=null&&AddEvtHandler(p,"onclick",w)}function E(){a:;var b=[];if(d!=null||c!=null){b[0]=d;b[1]=c}else b=null;if(typeof _spPageContextInfo!="undefined"&&_spPageContextInfo!=null&&typeof _spPageContextInfo.webServerRelativeUrl!="undefined"&&_spPageContextInfo.webServerRelativeUrl!=null){var a=_spPageContextInfo.webServerRelativeUrl;if(a.charAt(a.length-1)!="/")a=a+"/";var e={url:a+"_layouts/15/definelocation.aspx?latitude="+String(d)+"&longitude="+String(c),args:b,width:350,dialogReturnValueCallback:y};EnsureScriptParams("SP.UI.Dialog.js","SP.UI.ModalDialog.showModalDialog",e)}else throw"Definelocation dialog can not be launched as URL can not be formed properly.";}function w(){a:;f!=null&&d!=null&&c!=null&&h!=null&&ExecuteOrDelayUntilEventNotified(function(){a:;f.clearMap()},"bingmapjsloaded");d=null;c=null}function y(b,a){i!=null&&i.focus();if(b==SP.UI.DialogResult.OK)if(a==null)w();else if(a.length<2)return;else{d=a[0];c=a[1];if(d!=null&&c!=null&&h!=null){s();ExecuteOrDelayUntilEventNotified(function(){a:;r(d,c,h);o(d,c)},"bingmapjsloaded")}}else if(b==SP.UI.DialogResult.cancel)return}},RenderGeolocationField:function(e,b,c){if(b.XSLRender=="1")return c[b.Name].toString();else{var d=GeolocationFieldTemplate.ParseGeolocationValue(c[b.Name]),a=[];if(d!=null){a.push('<a class="js-locationfield-callout" href="javascript:void(0)" liid="');a.push(GenerateIID(e));a.push('" fld="');a.push(b.Name);a.push('" fldDisplayName="');a.push(STSHtmlEncode(b.DisplayName));a.push('" ><img title="');a.push(STSHtmlEncode(Strings.STS.L_Clippy_Tooltip));a.push('"border=0 src="/_layouts/15/images/ADDR_GETMAP.16x16x32.png?rev=23');a.push('"/></a>')}return a.join("")}},SetupMappyHoverHandlers:function(c,b){EnsureScriptFunc("callout.js","Callout",function(){a:;EnsureScriptFunc("core.js","GetListItemByIID",function(){a:;EnsureScriptFunc("mquery.js","m$",function(){a:;m$(".js-locationfield-callout").not(".js-locationfield-calloutInitialized").forEach(function(e){var f=e.getAttribute("liid"),g=e.getAttribute("fld"),j=e.getAttribute("fldDisplayName"),d=[],k=GetListItemByIID(f),h=GeolocationFieldTemplate.ParseGeolocationValue(k[g]);d.push("<div class='js-callout-bodySection'><div class='ms-positionRelative' id='loc_mapcontainer_");d.push(f);d.push("_");d.push(g);d.push("' style='width:280px;height:280px;' >");d.push(a);d.push("</div></div>");var i=function(){a:;ExecuteOrDelayUntilEventNotified(function(){a:;GeolocationFieldTemplate.ShowMappyHover(g,f,h,b)},"bingmapjsloaded")},l=CalloutManager.createNew({launchPoint:e,openOptions:{closeCalloutOnBlur:true,event:"click",showCloseButton:true},ID:f+"_"+g,title:j,content:d.join(""),beakOrientation:"leftRight",onOpeningCallback:i,contentWidth:320});l.addAction(new CalloutAction({text:Strings.STS.L_ViewOnMap,onClickCallback:function(){a:;var a=GeolocationFieldTemplate.GetRedirectUrl(c.CurrentUICultureName,h.latitude,h.longitude);window.open(a)}}));m$(e).addClass("js-locationfield-calloutInitialized")})})})})},ShowMappyHover:function(g,f,d,h){var i=document.getElementById("loc_mapcontainer_"+f+"_"+g),e=new SP.Maps.MapProviderFactory.createMapProvider("Bing","7.0"),c=[],a={};a.latitude=d.latitude;a.longitude=d.longitude;a.isDraggable=false;a.showHover=false;a.icon="/_layouts/15/images/MapPushpin.25x39x32.png?rev=23";c.push(a);var b=new SP.Maps.SPMapOption;b.mapDiv=i;b.apiKey=h;b.center=new SP.Maps.Geolocation(a.latitude,a.longitude);b.height=280;b.width=280;e.loadMap(b);e.addPushpins(c)},GetRedirectUrl:function(a,c,b){return"http://officeredir.microsoft.com/r/rlidSPGeolocationMap?clid="+a+"&p1="+String(c)+"&p2="+String(GeolocationFieldTemplate.NormalizeLongitude(b))},NormalizeLongitude:function(a){if(a<-180||a>180)a-=Math.floor((a+180)/360)*360;return a},OnGeolocationFieldPostRender:function(a){if(a!=null&&a.BaseViewID!="MapView"&&a.BaseViewID!="NewForm"&&a.BaseViewID!="EditForm"&&a.BaseViewID!="DisplayForm"){var b=a.ListSchema.Field;for(var c in b)if(b[c].Type=="Geolocation"){var d=b[c].IsBingMapBlockedInCurrentRegion=="TRUE"?true:false,e=b[c].BingMapsKey;ExecuteOrDelayUntilEventNotified(function(){a:;SP.Maps.BingMaps.blockedStatus(d)},"bingmapjsloaded");GeolocationFieldTemplate.SetupMappyHoverHandlers(a,e);break}}}}}();function a(){a:;var a={};a.Templates={};a.OnPostRender=GeolocationFieldTemplate.OnGeolocationFieldPostRender;a.Templates.Fields={Geolocation:{View:GeolocationFieldTemplate.RenderGeolocationField,DisplayForm:GeolocationFieldTemplate.SPFieldGeolocation_Display,EditForm:GeolocationFieldTemplate.SPFieldGeolocation_Edit,NewForm:GeolocationFieldTemplate.SPFieldGeolocation_Edit}};SPClientTemplates.TemplateManager.RegisterTemplateOverrides(a)}ExecuteOrDelayUntilScriptLoaded(a,"clienttemplates.js");_spBodyOnLoadFunctionNames.push("LoadBingMapsApi")})();typeof Sys!="undefined"&&typeof Sys.Application!="undefined"&&typeof Sys.Application.notifyScriptLoaded!="undefined"&&Sys.Application.notifyScriptLoaded();typeof NotifyScriptLoadedAndExecuteWaitingJobs=="function"&&NotifyScriptLoadedAndExecuteWaitingJobs("geolocationfieldtemplate.js")}function ULSpCg(){var a={};a.ULSTeamName="Microsoft SharePoint Foundation";a.ULSFileName="geolocationfieldtemplate.commentedjs";return a}function mapScriptLoaded(){a:;typeof NotifyScriptLoadedAndExecuteWaitingJobs=="function"&&ExecuteOrDelayUntilScriptLoaded(function(){a:;NotifyEventAndExecuteWaitingJobs("bingmapjsloaded")},"SP.Map.js")}function LoadBingMapsApi(){a:;var b="ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&onscriptload=mapScriptLoaded";typeof Microsoft!="undefined"&&typeof Microsoft.Maps!="undefined"&&typeof Microsoft.Maps.Location!="undefined"&&CleanBingMapScripts();var c=STSHtmlEncode(Strings.STS.L_CurrentUICulture_Name),d=document.location.protocol,a=document.createElement("script");a.type="text/javascript";a.id="virtualearthscript";if("https:"==d)a.src="https://"+b+"&s=1&mkt="+c;else a.src="http://"+b+"&mkt="+c;var e=document.getElementsByTagName("head")[0];e.appendChild(a)}function CleanBingMapScripts(){a:;for(var g="ecn.dev.virtualearth.net",b=[],f=document.getElementsByTagName("head")[0],c=f.getElementsByTagName("script"),d=c.length,h=null,a=0;a<d;a++){var e=c[a].src;if(null!=e&&e.length>0)e.toLowerCase().indexOf(g)>0&&b.push(c[a])}d=b.length;for(a=0;a<d;a++)f.removeChild(b[a])}$_global_geolocationfieldtemplate();